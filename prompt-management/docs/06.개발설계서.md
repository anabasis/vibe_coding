# LLM 프롬프트 관리 서비스 개발 설계서

## 1. 개요

이 문서는 LLM 프롬프트 관리 서비스의 기술적 구현 상세를 정의합니다. 데이터베이스 스키마, API 설계, 인증/인가 로직, 컴포넌트 구조 등을 포함합니다.

---

## 2. 데이터베이스 설계

### 2.1. 데이터베이스 선택

- **데이터베이스**: SQLite
- **파일 경로**: `./prompt_management.db`
- **이유**: 
  - 로컬 파일 기반으로 간단한 배포
  - 개발 및 테스트 용이성
  - 향후 PostgreSQL/Supabase로 마이그레이션 가능

### 2.2. 스키마 상세

#### 2.2.1. `profiles` 테이블

사용자 프로필 정보를 저장합니다.

```sql
CREATE TABLE IF NOT EXISTS profiles (
    id TEXT PRIMARY KEY,              -- UUID
    nickname TEXT NOT NULL,            -- 닉네임
    avatar_url TEXT,                   -- 프로필 이미지 URL (nullable)
    updated_at TEXT NOT NULL           -- ISO8601 timestamp
);
```

**인덱스:**
- `idx_profiles_id`: `id` 컬럼

**제약사항:**
- `id`는 UUID 형식
- `nickname`은 필수 입력

---

#### 2.2.2. `prompts` 테이블 (핵심 테이블)

프롬프트 정보를 저장합니다.

```sql
CREATE TABLE IF NOT EXISTS prompts (
    id TEXT PRIMARY KEY,              -- UUID
    created_at TEXT NOT NULL,          -- ISO8601 timestamp
    title TEXT NOT NULL,                -- 제목
    description TEXT NOT NULL,          -- 설명
    price INTEGER NOT NULL,             -- 가격 (관리 서비스에서는 사용 안 함, 호환성 유지)
    prompt_text TEXT NOT NULL,          -- 프롬프트 본문 (관리자만 조회 가능)
    image_urls TEXT NOT NULL DEFAULT '[]',  -- JSON array (이미지 URL 목록)
    tags TEXT NOT NULL DEFAULT '[]',        -- JSON array (태그 목록)
    rating REAL NOT NULL DEFAULT 0,          -- 평점 (향후 확장용)
    review_count INTEGER NOT NULL DEFAULT 0, -- 리뷰 수 (향후 확장용)
    download_count INTEGER NOT NULL DEFAULT 0, -- 다운로드 수 (향후 확장용)
    view_count INTEGER NOT NULL DEFAULT 0,     -- 조회수 (TOP10 기준)
    file_url TEXT,                          -- 파일 URL (향후 확장용)
    is_published INTEGER NOT NULL DEFAULT 1   -- 공개 여부 (0: 비공개, 1: 공개)
);
```

**인덱스:**
- `idx_prompts_id`: `id` 컬럼
- `idx_prompts_is_published`: `is_published` 컬럼
- `idx_prompts_view_count`: `view_count` 컬럼 (TOP10 조회 최적화)

**제약사항:**
- `id`는 UUID 형식
- `title`, `description`, `prompt_text`는 필수 입력
- `image_urls`, `tags`는 JSON 배열 형식 (빈 배열 `[]` 기본값)
- `is_published`는 0 또는 1 (boolean)

**TOP10 조회 쿼리:**
```sql
SELECT * FROM prompts 
WHERE is_published = 1 
ORDER BY view_count DESC 
LIMIT 10;
```

---

#### 2.2.3. 기타 테이블 (호환성 유지)

다음 테이블들은 기존 스키마와의 호환성을 위해 유지하되, 관리 서비스에서는 사용하지 않습니다:
- `carts`: 장바구니 (사용 안 함)
- `purchases`: 구매 기록 (사용 안 함)
- `seller_waitlist`: 판매자 웨이팅 리스트 (사용 안 함)
- `mcp_servers`: MCP 서버 정보 (향후 확장용)

---

### 2.3. 데이터 타입 매핑

| SQLite 타입 | TypeScript 타입 | 설명 |
|------------|----------------|------|
| TEXT | string | 문자열 |
| INTEGER | number | 정수 |
| REAL | number | 실수 |
| TEXT (JSON) | string[] | JSON 배열 (파싱 필요) |
| INTEGER (boolean) | boolean | 0 또는 1 |

---

## 3. API 설계

### 3.1. API 아키텍처

Next.js App Router의 Server Actions 또는 API Routes를 사용합니다.

**권장 방식:**
- **Server Actions**: 폼 제출, 데이터 변경 작업
- **API Routes**: RESTful API가 필요한 경우

### 3.2. 인증 관련 API

#### 3.2.1. 로그인

**엔드포인트:** `POST /api/auth/login`

**요청:**
```typescript
{
  email: string;
  password: string;
}
```

**응답:**
```typescript
{
  success: boolean;
  user?: {
    id: string;
    nickname: string;
    avatar_url?: string;
  };
  error?: string;
}
```

**구현 위치:** `app/api/auth/login/route.ts` 또는 Server Action

---

#### 3.2.2. 로그아웃

**엔드포인트:** `POST /api/auth/logout`

**응답:**
```typescript
{
  success: boolean;
}
```

**구현 위치:** `app/api/auth/logout/route.ts` 또는 Server Action

---

#### 3.2.3. 인증 상태 확인

**엔드포인트:** `GET /api/auth/me`

**응답:**
```typescript
{
  user?: {
    id: string;
    nickname: string;
    avatar_url?: string;
  };
  isAuthenticated: boolean;
}
```

**구현 위치:** `app/api/auth/me/route.ts`

---

### 3.3. 프롬프트 관리 API

#### 3.3.1. 프롬프트 목록 조회 (관리자)

**엔드포인트:** `GET /api/prompts?page=1&limit=20&search=&sort=created_at&order=desc`

**쿼리 파라미터:**
- `page`: 페이지 번호 (기본값: 1)
- `limit`: 페이지당 항목 수 (기본값: 20)
- `search`: 검색어 (제목, 설명, 태그 검색)
- `sort`: 정렬 기준 (`created_at`, `view_count`, `title`)
- `order`: 정렬 방향 (`asc`, `desc`)
- `is_published`: 공개 여부 필터 (선택)

**인증:** 로그인 필요

**응답:**
```typescript
{
  prompts: Prompt[];
  total: number;
  page: number;
  limit: number;
  totalPages: number;
}
```

**구현 위치:** `app/api/prompts/route.ts`

---

#### 3.3.2. TOP10 프롬프트 조회 (비로그인)

**엔드포인트:** `GET /api/prompts/top10?search=`

**쿼리 파라미터:**
- `search`: 검색어 (선택, TOP10 내에서만 검색)

**인증:** 불필요

**응답:**
```typescript
{
  prompts: Omit<Prompt, 'prompt_text'>[]; // prompt_text 제외
}
```

**구현 위치:** `app/api/prompts/top10/route.ts`

---

#### 3.3.3. 프롬프트 상세 조회

**엔드포인트:** `GET /api/prompts/[id]`

**인증:** 
- 비로그인: 제한된 정보만 반환 (prompt_text 제외)
- 로그인: 전체 정보 반환

**응답 (비로그인):**
```typescript
{
  id: string;
  title: string;
  description: string;
  image_urls: string[];
  tags: string[];
  view_count: number;
  created_at: string;
  // prompt_text 제외
}
```

**응답 (로그인):**
```typescript
{
  id: string;
  title: string;
  description: string;
  prompt_text: string; // 포함
  image_urls: string[];
  tags: string[];
  view_count: number;
  created_at: string;
  is_published: boolean;
}
```

**구현 위치:** `app/api/prompts/[id]/route.ts`

---

#### 3.3.4. 프롬프트 생성

**엔드포인트:** `POST /api/prompts`

**인증:** 로그인 필요

**요청:**
```typescript
{
  title: string;
  description: string;
  prompt_text: string;
  image_urls?: string[];
  tags?: string[];
  is_published?: boolean;
}
```

**응답:**
```typescript
{
  success: boolean;
  prompt?: Prompt;
  error?: string;
}
```

**구현 위치:** `app/api/prompts/route.ts` (POST)

---

#### 3.3.5. 프롬프트 수정

**엔드포인트:** `PUT /api/prompts/[id]`

**인증:** 로그인 필요

**요청:**
```typescript
{
  title?: string;
  description?: string;
  prompt_text?: string;
  image_urls?: string[];
  tags?: string[];
  is_published?: boolean;
}
```

**응답:**
```typescript
{
  success: boolean;
  prompt?: Prompt;
  error?: string;
}
```

**구현 위치:** `app/api/prompts/[id]/route.ts` (PUT)

---

#### 3.3.6. 프롬프트 삭제

**엔드포인트:** `DELETE /api/prompts/[id]`

**인증:** 로그인 필요

**응답:**
```typescript
{
  success: boolean;
  error?: string;
}
```

**구현 위치:** `app/api/prompts/[id]/route.ts` (DELETE)

---

#### 3.3.7. 조회수 증가

**엔드포인트:** `POST /api/prompts/[id]/view`

**인증:** 불필요

**응답:**
```typescript
{
  success: boolean;
  view_count: number;
}
```

**구현 위치:** `app/api/prompts/[id]/view/route.ts`

**주의사항:**
- 중복 증가 방지 (세션 또는 쿠키 기반)
- 비동기 처리 권장

---

### 3.4. 프로필 관리 API

#### 3.4.1. 프로필 조회

**엔드포인트:** `GET /api/profile`

**인증:** 로그인 필요

**응답:**
```typescript
{
  id: string;
  nickname: string;
  avatar_url?: string;
  updated_at: string;
}
```

---

#### 3.4.2. 프로필 수정

**엔드포인트:** `PUT /api/profile`

**인증:** 로그인 필요

**요청:**
```typescript
{
  nickname?: string;
  avatar_url?: string;
}
```

**응답:**
```typescript
{
  success: boolean;
  profile?: Profile;
  error?: string;
}
```

---

## 4. 인증/인가 로직 설계

### 4.1. 인증 방식

**현재 구현:**
- localStorage 기반 인증 상태 관리
- Context API를 통한 전역 상태 관리

**향후 확장:**
- JWT 토큰 기반 인증
- 세션 기반 인증
- Supabase Auth 연동

### 4.2. 인증 상태 관리

**구현 위치:** `contexts/auth-context.tsx`

**상태:**
```typescript
interface AuthState {
  user: Profile | null;
  isAuthenticated: boolean;
}
```

**메서드:**
- `login(email, password)`: 로그인
- `logout()`: 로그아웃
- `updateProfile(nickname, avatar_url)`: 프로필 업데이트

### 4.3. 라우트 보호 (Route Protection)

**구현 방식:**

1. **Middleware 사용 (권장)**
   - `middleware.ts`에서 인증 확인
   - 보호된 라우트 리다이렉트

2. **컴포넌트 레벨 보호**
   - `useAuth()` 훅으로 인증 상태 확인
   - 미인증 시 로그인 페이지로 리다이렉트

**보호된 라우트:**
- `/admin/prompts/*`: 관리자 전용
- `/profile`: 로그인 필요

**예시 구현:**
```typescript
// app/admin/prompts/page.tsx
"use client";

import { useAuth } from "@/contexts/auth-context";
import { useRouter } from "next/navigation";
import { useEffect } from "react";

export default function AdminPromptsPage() {
  const { isAuthenticated } = useAuth();
  const router = useRouter();

  useEffect(() => {
    if (!isAuthenticated) {
      router.push("/login");
    }
  }, [isAuthenticated, router]);

  if (!isAuthenticated) {
    return null; // 또는 로딩 스피너
  }

  // 관리자 페이지 내용
}
```

### 4.4. 권한 기반 데이터 접근

**구현 위치:** API Routes 또는 Server Actions

**로직:**
```typescript
// app/api/prompts/[id]/route.ts
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const session = await getSession(request);
  const prompt = await getPromptById(params.id);

  if (!session) {
    // 비로그인: prompt_text 제외
    return Response.json({
      ...prompt,
      prompt_text: undefined,
    });
  }

  // 로그인: 전체 정보 반환
  return Response.json(prompt);
}
```

---

## 5. 프론트엔드 컴포넌트 구조

### 5.1. 디렉토리 구조

```
components/
├── ui/                    # 기본 UI 컴포넌트 (shadcn/ui)
│   ├── button.tsx
│   ├── input.tsx
│   ├── card.tsx
│   └── ...
├── header.tsx             # 헤더 컴포넌트
├── prompt-card.tsx        # 프롬프트 카드 컴포넌트
├── prompt-form.tsx        # 프롬프트 생성/수정 폼
├── prompt-list.tsx        # 프롬프트 목록
└── search-bar.tsx         # 검색 바 컴포넌트
```

### 5.2. 주요 컴포넌트 명세

#### 5.2.1. `PromptCard`

프롬프트 카드 컴포넌트 (목록에서 사용)

**Props:**
```typescript
interface PromptCardProps {
  prompt: Omit<Prompt, 'prompt_text'>; // prompt_text 제외
  showActions?: boolean; // 관리자용 액션 버튼 표시 여부
  onEdit?: (id: string) => void;
  onDelete?: (id: string) => void;
}
```

**구현 위치:** `components/prompt-card.tsx`

---

#### 5.2.2. `PromptForm`

프롬프트 생성/수정 폼 컴포넌트

**Props:**
```typescript
interface PromptFormProps {
  initialData?: Prompt; // 수정 모드일 경우
  onSubmit: (data: PromptFormData) => Promise<void>;
  onCancel: () => void;
}
```

**구현 위치:** `components/prompt-form.tsx`

---

#### 5.2.3. `SearchBar`

검색 바 컴포넌트

**Props:**
```typescript
interface SearchBarProps {
  placeholder?: string;
  onSearch: (query: string) => void;
  disabled?: boolean; // 비로그인 사용자용 제한 표시
}
```

**구현 위치:** `components/search-bar.tsx`

---

### 5.3. 페이지 컴포넌트

#### 5.3.1. 메인 페이지

**경로:** `app/page.tsx`

**기능:**
- TOP10 프롬프트 표시
- 검색 기능 (TOP10 내에서만)
- 로그인 사용자: 관리 페이지 링크

---

#### 5.3.2. 프롬프트 관리 페이지

**경로:** `app/admin/prompts/page.tsx`

**기능:**
- 전체 프롬프트 목록
- 검색 및 필터링
- 프롬프트 생성/수정/삭제

---

#### 5.3.3. 프롬프트 상세 페이지

**경로:** `app/prompts/[id]/page.tsx`

**기능:**
- 프롬프트 상세 정보 표시
- 역할별 다른 정보 표시 (prompt_text)
- 조회수 증가

---

## 6. 상태 관리 전략

### 6.1. 전역 상태

**인증 상태:**
- Context API (`contexts/auth-context.tsx`)
- localStorage 동기화

**프롬프트 목록:**
- Server Components에서 데이터 페칭
- 클라이언트 상태는 필요 시에만 사용

### 6.2. 로컬 상태

**폼 상태:**
- React Hook Form 사용
- 컴포넌트 내부 상태 관리

**UI 상태:**
- `useState` 훅 사용
- 모달, 다이얼로그 열림/닫힘 상태

### 6.3. 서버 상태

**데이터 페칭:**
- Next.js Server Components 활용
- `fetch` API 사용 (캐싱 옵션 설정)

**예시:**
```typescript
// app/admin/prompts/page.tsx
async function getPrompts(searchParams: SearchParams) {
  const response = await fetch(
    `${process.env.NEXT_PUBLIC_API_URL}/api/prompts?${new URLSearchParams(searchParams)}`,
    {
      cache: 'no-store', // 또는 'force-cache'
    }
  );
  return response.json();
}
```

---

## 7. 검색 및 필터링 로직

### 7.1. 검색 범위

**관리자 (로그인):**
- 전체 프롬프트 데이터에서 검색
- 검색 대상: 제목, 설명, 태그, 프롬프트 본문

**비로그인 사용자:**
- TOP10 프롬프트 내에서만 검색
- 검색 대상: 제목, 설명, 태그

### 7.2. 검색 구현

**SQL 쿼리 예시:**
```sql
-- 관리자용 전체 검색
SELECT * FROM prompts
WHERE (
  title LIKE '%검색어%' 
  OR description LIKE '%검색어%'
  OR prompt_text LIKE '%검색어%'
  OR tags LIKE '%검색어%'
)
AND is_published = 1
ORDER BY view_count DESC;

-- 비로그인용 TOP10 검색
SELECT * FROM prompts
WHERE id IN (
  SELECT id FROM prompts 
  WHERE is_published = 1 
  ORDER BY view_count DESC 
  LIMIT 10
)
AND (
  title LIKE '%검색어%' 
  OR description LIKE '%검색어%'
  OR tags LIKE '%검색어%'
);
```

**주의사항:**
- SQL Injection 방지 (파라미터화된 쿼리 사용)
- 성능 최적화 (인덱스 활용)
- 대소문자 구분 없이 검색 (LIKE 대신 대소문자 무시 검색)

### 7.3. 태그 검색

**구현:**
- `tags` 컬럼은 JSON 배열 형식
- JSON 검색 또는 파싱 후 검색

**예시:**
```sql
-- JSON 배열에서 태그 검색
SELECT * FROM prompts
WHERE tags LIKE '%"태그명"%';
```

---

## 8. 이미지 업로드 및 관리

### 8.1. 이미지 저장 방식

**옵션 1: 로컬 파일 시스템**
- `public/uploads/` 디렉토리에 저장
- 파일명: UUID 또는 타임스탬프 기반

**옵션 2: 외부 스토리지 (향후)**
- Supabase Storage
- AWS S3
- Cloudinary

### 8.2. 이미지 업로드 API

**엔드포인트:** `POST /api/upload`

**요청:**
- `FormData` 형식
- `file`: 이미지 파일

**응답:**
```typescript
{
  success: boolean;
  url?: string; // 업로드된 이미지 URL
  error?: string;
}
```

---

## 9. 에러 처리

### 9.1. API 에러 처리

**에러 응답 형식:**
```typescript
{
  success: false;
  error: string;
  code?: string; // 에러 코드 (선택)
}
```

**에러 코드:**
- `AUTH_REQUIRED`: 인증 필요
- `NOT_FOUND`: 리소스 없음
- `VALIDATION_ERROR`: 유효성 검사 실패
- `INTERNAL_ERROR`: 서버 내부 오류

### 9.2. 클라이언트 에러 처리

**구현:**
- Try-catch 블록 사용
- Toast 알림으로 사용자에게 에러 표시
- 에러 바운더리 구현 (선택)

---

## 10. 성능 최적화

### 10.1. 데이터베이스 최적화

- 인덱스 활용 (조회수, 공개 여부)
- 페이지네이션으로 데이터 분할
- 쿼리 최적화 (불필요한 JOIN 제거)

### 10.2. 프론트엔드 최적화

- 이미지 지연 로딩 (Lazy Loading)
- 스켈레톤 UI로 로딩 상태 표시
- React.memo로 불필요한 리렌더링 방지
- Next.js Image 컴포넌트 사용

### 10.3. 캐싱 전략

- Next.js 캐싱 옵션 활용
- 정적 데이터는 `force-cache` 사용
- 동적 데이터는 `no-store` 사용

---

## 11. 보안 고려사항

### 11.1. 입력 검증

- 클라이언트 및 서버 양쪽에서 검증
- SQL Injection 방지 (파라미터화된 쿼리)
- XSS 방지 (입력 데이터 이스케이프)

### 11.2. 인증 보안

- 비밀번호 해싱 (bcrypt 등)
- 세션 관리 (향후)
- CSRF 방지 (향후)

### 11.3. 데이터 접근 제어

- 역할 기반 접근 제어 (RBAC)
- API 레벨에서 권한 확인
- 민감 정보 마스킹 (prompt_text)

---

## 12. 테스트 전략

### 12.1. 단위 테스트

- 유틸리티 함수 테스트
- 컴포넌트 렌더링 테스트

### 12.2. 통합 테스트

- API 엔드포인트 테스트
- 데이터베이스 쿼리 테스트

### 12.3. E2E 테스트

- 사용자 플로우 테스트 (선택)

---

## 13. 배포 및 운영

### 13.1. 환경 변수

```
DATABASE_PATH=./prompt_management.db
NEXT_PUBLIC_API_URL=http://localhost:3000
JWT_SECRET=your-secret-key (향후)
```

### 13.2. 데이터베이스 백업

- 정기적인 SQLite 파일 백업
- 마이그레이션 스크립트 준비

### 13.3. 모니터링

- 에러 로깅
- 성능 모니터링 (선택)

---

## 14. 향후 확장 계획

### 14.1. 인증 시스템 고도화

- JWT 토큰 기반 인증
- Supabase Auth 연동
- 소셜 로그인 (Google, GitHub 등)

### 14.2. 데이터베이스 마이그레이션

- PostgreSQL 또는 Supabase로 전환
- 관계형 데이터베이스의 장점 활용

### 14.3. 추가 기능

- 프롬프트 카테고리 관리
- 통계 및 분석 대시보드
- 프롬프트 버전 관리
- 다중 관리자 지원

---

## 15. 참고 자료

- [Next.js 공식 문서](https://nextjs.org/docs)
- [SQLite 공식 문서](https://www.sqlite.org/docs.html)
- [React Hook Form](https://react-hook-form.com/)
- [shadcn/ui](https://ui.shadcn.com/)




